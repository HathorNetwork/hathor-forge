name: Build

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.11

      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Build hathor-core
        run: nix develop --command ./scripts/build-hathor-core.sh
        continue-on-error: true  # May fail if hathor-core source not available

      - name: Build cpuminer
        run: nix develop --command ./scripts/build-cpuminer.sh
        continue-on-error: true  # May fail if cpuminer source not available

      - name: Build wallet-headless
        run: nix develop --command ./scripts/build-wallet-headless.sh
        continue-on-error: true

      - name: Build explorer
        run: nix develop --command ./scripts/build-explorer.sh
        continue-on-error: true

      - name: Install npm dependencies
        run: nix develop --command npm ci

      - name: Build Tauri app
        run: nix develop --command npm run tauri build
        continue-on-error: true  # May fail if binaries not built

      - name: Upload Linux bundle
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: linux-bundle
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: ignore

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.11

      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Build hathor-core
        run: nix develop --command ./scripts/build-hathor-core.sh
        continue-on-error: true

      - name: Build cpuminer
        run: nix develop --command ./scripts/build-cpuminer.sh
        continue-on-error: true

      - name: Build wallet-headless
        run: nix develop --command ./scripts/build-wallet-headless.sh
        continue-on-error: true

      - name: Build explorer
        run: nix develop --command ./scripts/build-explorer.sh
        continue-on-error: true

      - name: Install npm dependencies
        run: nix develop --command npm ci

      - name: Build Tauri app
        run: nix develop --command npm run tauri build
        continue-on-error: true

      - name: Upload macOS bundle
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: macos-bundle
          path: |
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/macos/*.app
          if-no-files-found: ignore

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install MSYS2 (for cpuminer autotools)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-curl
            autoconf
            automake
            libtool
            make

      - name: Build hathor-core (Windows)
        shell: pwsh
        run: |
          Write-Host "hathor-core Windows build requires manual setup"
          Write-Host "Install hathor-core via pip and build with PyInstaller"
        continue-on-error: true

      - name: Build cpuminer (Windows/MSYS2)
        shell: msys2 {0}
        run: |
          echo "cpuminer Windows build requires hathor cpuminer source"
          echo "Clone and build: ./autogen.sh && ./configure && make"
        continue-on-error: true

      - name: Install npm dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build
        continue-on-error: true

      - name: Upload Windows bundle
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: windows-bundle
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: ignore

  # Rust checks (runs quickly without needing binaries)
  check:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.11

      - name: Check Rust formatting
        run: nix develop --command cargo fmt --manifest-path src-tauri/Cargo.toml -- --check
